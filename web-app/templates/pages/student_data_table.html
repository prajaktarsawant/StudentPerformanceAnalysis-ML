{% extends "base.html" %}

{% block page_header %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Data Records</li>
    </ol>
</nav>
<h1 class="mb-4"><i class="bi bi-database me-2"></i>Student Performance Data</h1>
{% endblock %}

{% block content %}

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Full Student Records</h5>
            <div>
                <button type="button" class="btn btn-sm btn-info me-2 text-white" data-bs-toggle="modal" data-bs-target="#emailInviteModal">
                    <i class="bi bi-envelope me-1"></i> Invite Data Entry
                </button>
                
                <a href="/data/import" class="btn btn-sm btn-outline-secondary me-2"><i class="bi bi-upload me-1"></i> Import CSV</a>
                <a href="{{ url_for('add_student_form') }}" class="btn btn-sm btn-primary"><i class="bi bi-plus-lg me-1"></i> Add New Record</a>
            </div>
        </div>
        <div class="modal fade" id="emailInviteModal" tabindex="-1" aria-labelledby="emailInviteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="POST" action="{{ url_for('send_invitations') }}">
                        <div class="modal-header">
                            <h5 class="modal-title" id="emailInviteModalLabel">Send Data Entry Invitation</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted">Enter a comma-separated list of email addresses below. They will receive an email with a unique link to fill out the student data form.</p>
                            <div class="mb-3">
                                <label for="emailList" class="form-label">Email Addresses (Comma-Separated)</label>
                                <textarea class="form-control" id="emailList" name="email_list" rows="4" required placeholder="email1@example.com, email2@example.com, ..."></textarea>
                            </div>
                            <p class="small text-danger">⚠️ Ensure your backend email service (like SMTP) is configured correctly for this function to work.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-info text-white"><i class="bi bi-send-fill me-1"></i> Send Invitations</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="card-body p-3">
            
            {% if students %}
            <div class="table-responsive">
                <table id="studentDataTable" class="table table-striped table-hover table-sm w-100">
                    <thead class="bg-light">
                        <tr>
                            <th>ID</th>
                            <th>Age Range</th>
                            <th>Sex</th>
                            <th>School Type</th>
                            <th>Scholarship</th>
                            <th>Add'l Work</th>
                            <th>Sports</th>
                            <th>Transport</th>
                            <th>Study Hrs</th>
                            <th>Attendance</th>
                            <th>Reading</th>
                            <th>Notes</th>
                            <th>Listening</th>
                            <th>Project</th>
                            <th>Final Grade</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td>{{ student.Student_ID }}</td>
                            <td>{{ student.Student_Age }}</td>
                            <td>{{ student.Sex }}</td>
                            <td>{{ student.High_School_Type }}</td>
                            
                            <td>
                                {% set scholarship_status = student.Scholarship%}
                                <span class="badge bg-success">
                                    {{ student.Scholarship }}
                                </span>
                            </td>
                            
                            <td>
                                {% set work_status = student.Additional_Work.lower() %}
                                <span class="badge {% if 'yes' in work_status %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                    {{ student.Additional_Work }}
                                </span>
                            </td>

                            <td>
                                {% set sports_status = student.Sports_activity.lower() %}
                                <span class="badge {% if 'yes' in sports_status %}bg-info{% else %}bg-secondary{% endif %}">
                                    {{ student.Sports_activity }}
                                </span>
                            </td>

                            <td>{{ student.Transportation }}</td>
                            
                            <td>{{ student.Weekly_Study_Hours }}</td> 
                            
                            <td>{{ student.Attendance }}</td>
                            
                            <td>{{ student.Reading }}</td>
                            <td>{{ student.Notes }}</td>
                            <td>{{ student.Listening_in_Class }}</td>
                            <td>{{ student.Project_work }}</td>
                            <td><span class="fw-bold text-primary">{{ student.Grade }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>ID</th>
                            <th>Age Range</th>
                            <th>Sex</th>
                            <th>School Type</th>
                            <th>Scholarship</th>
                            <th>Add'l Work</th>
                            <th>Sports</th>
                            <th>Transport</th>
                            <th>Study Hrs</th>
                            <th>Attendance</th>
                            <th>Reading</th>
                            <th>Notes</th>
                            <th>Listening</th>
                            <th>Project</th>
                            <th>Grade</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5 text-muted">
                <i class="bi bi-database-slash display-4 mb-3"></i>
                <p>No student records found in the database.</p>
                <a href="/data/import" class="btn btn-outline-primary"><i class="bi bi-upload me-1"></i> Start by Importing Data</a>
            </div>
            {% endif %}

        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('#studentDataTable').DataTable({
            // DataTables configuration options for a professional look
            "scrollX": true, 
            "paging": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "responsive": true,
            
            // CORRECTED: Configure the exact pagination options (10, 20, 50, 100, All)
            "lengthMenu": [ 
                [10, 20, 50, 100, -1], // Value array (what DataTables sees: -1 means All)
                [10, 20, 50, 100, "All"]  // Display array (what the user sees)
            ],
            
            "language": {
                "search": "Filter Records:",
                "lengthMenu": "Show _MENU_ entries"
            }
        });
    });
</script>
{% endblock %}